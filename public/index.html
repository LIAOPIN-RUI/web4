<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>éŠ…åƒ¹ç®¡ç†ç³»çµ±</title>
</head>
<body>
<h1>éŠ…åƒ¹ç®¡ç†ç³»çµ±</h1>

<h2>ğŸ” æŸ¥è©¢æ‰€æœ‰éŠ…åƒ¹è³‡æ–™</h2>
<button onclick="fetchAll()">æŸ¥è©¢å…¨éƒ¨</button>
<table border="1" id="dataTable">
  <thead>
  <tr>
    <th>å¹´ä»½</th><th>å¹³å‡åƒ¹</th><th>æœ€é«˜åƒ¹</th><th>æœ€ä½åƒ¹</th><th>å¹´å¹…åº¦ (%)</th>
  </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>ğŸ” æŸ¥è©¢ç‰¹å®šå¹´ä»½</h2>
<input type="number" id="searchYear" placeholder="è¼¸å…¥å¹´ä»½">
<button onclick="searchYear()">æŸ¥è©¢</button>
<div id="searchResult"></div>

<h2>âœï¸ æ–°å¢è³‡æ–™</h2>
<form id="insertForm">
  <input type="number" name="year" placeholder="å¹´ä»½" required>
  <input type="number" step="0.01" name="average_price" placeholder="å¹³å‡åƒ¹" required>
  <input type="number" step="0.01" name="highest_price" placeholder="æœ€é«˜åƒ¹" required>
  <input type="number" step="0.01" name="lowest_price" placeholder="æœ€ä½åƒ¹" required>
  <input type="number" step="0.01" name="annual_range" placeholder="å¹´å¹…åº¦(%)" required>
  <button type="submit">æ–°å¢</button>
</form>

<script>
  // æŸ¥è©¢å…¨éƒ¨
  async function fetchAll() {
    const res = await fetch('/api/price');
    const data = await res.json();
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.year}</td>
                        <td>${row.average_price.toFixed(2)}</td>
                        <td>${row.highest_price.toFixed(2)}</td>
                        <td>${row.lowest_price.toFixed(2)}</td>
                        <td>${row.annual_range.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // æŸ¥è©¢å–®ç­†å¹´ä»½
  async function searchYear() {
    const year = document.getElementById('searchYear').value;
    const res = await fetch(`/api?year=${year}`);
    const result = await res.json();
    const div = document.getElementById('searchResult');
    if (result.error) {
      div.textContent = result.error;
    } else {
      div.innerHTML = `æŸ¥è©¢çµæœï¼š${result.year} å¹´ï¼Œå¹³å‡ ${result.average_price}ï¼Œé«˜ ${result.highest_price}ï¼Œä½ ${result.lowest_price}ï¼Œå¹…åº¦ ${result.annual_range}%`;
    }
  }

  // æ–°å¢è³‡æ–™
  document.getElementById('insertForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = new FormData(this);
    const data = Object.fromEntries(form.entries());
    const res = await fetch('/api/insert', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const text = await res.text();
    alert(text);
    this.reset();
    fetchAll(); // é‡æ–°è¼‰å…¥
  });

  // è¼‰å…¥æ™‚é¡¯ç¤ºå…¨éƒ¨è³‡æ–™
  window.onload = fetchAll;
</script>
</body>
</html>
